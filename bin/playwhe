#!/usr/bin/env ruby

# Usage:
#
# bundle exec ruby -Ilib bin/playwhe

require "http"
require "playwhe"

http = HTTP.timeout(:global, read: 5, write: 5, connect: 5)
http_adapter = PlayWhe::HTTP::Adapter.new(http)
url = "http://nlcb.co.tt/app/index.php/pwresults/playwhemonthsum"
fetcher = PlayWhe::Fetcher.new(http_adapter, url)

year = 2016
month = 1

results =
  begin
    fetcher.get(year: year, month: month)
  rescue PlayWhe::NetworkError => e
    $stderr.puts "Sorry, we encountered an unrecoverable error"
    $stderr.puts e.message
    $stderr.puts e.backtrace.join("\n")
    exit 1
  end

require 'ostruct'
context = OpenStruct.new(year: year, month: month)

PlayWhe::Parser.parse(results).each do |result|
  puts result if result.is_valid?(context)
end
